var __extends = this.__extends || function (d, b) {
		for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
		function __() {
			this.constructor = d;
		}

		__.prototype = b.prototype;
		d.prototype = new __();
	};
var CoreComment = (function () {
	function CoreComment(parent, init) {
		if (typeof init === "undefined") {
			init = {};
		}
		this.mode = 1;
		this.stime = 0;
		this.text = "";
		this.ttl = 4000;
		this.dur = 4000;
		this.cindex = -1;
		this.motion = [];
		this.movable = true;
		this._alphaMotion = null;
		this.absolute = true;
		this.align = 0;
		this._alpha = 1;
		this._size = 25;
		this._color = 0xffffff;
		this._border = false;
		this._shadow = true;
		this._font = "";
		if (!parent) {
			throw new Error("Comment not bound to comment manager.");
		} else {
			this.parent = parent;
		}
		if (init.hasOwnProperty("stime")) {
			this.stime = init["stime"];
		}
		if (init.hasOwnProperty("mode")) {
			this.mode = init["mode"];
		} else {
			this.mode = 1;
		}
		if (init.hasOwnProperty("dur")) {
			this.dur = init["dur"];
			this.ttl = this.dur;
		}
		this.dur *= this.parent.options.global.scale;
		this.ttl *= this.parent.options.global.scale;
		if (init.hasOwnProperty("text")) {
			this.text = init["text"];
		}
		if (init.hasOwnProperty("motion")) {
			this._motionStart = [];
			this._motionEnd = [];
			this.motion = init["motion"];
			var head = 0;
			for (var i = 0; i < init["motion"].length; i++) {
				this._motionStart.push(head);
				var maxDur = 0;
				for (var k in init["motion"][i]) {
					var m = init["motion"][i][k];
					maxDur = Math.max(m.dur, maxDur);
					if (m.easing === null || m.easing === undefined) {
						init["motion"][i][k]["easing"] = CoreComment.LINEAR;
					}
				}
				head += maxDur;
				this._motionEnd.push(head);
			}
			this._curMotion = 0;
		}
		if (init.hasOwnProperty("color")) {
			this._color = init["color"];
		}
		if (init.hasOwnProperty("size")) {
			this._size = init["size"];
		}
		if (init.hasOwnProperty("border")) {
			this._border = init["border"];
		}
		if (init.hasOwnProperty("opacity")) {
			this._alpha = init["opacity"];
		}
		if (init.hasOwnProperty("alpha")) {
			this._alphaMotion = init["alpha"];
		}
		if (init.hasOwnProperty("font")) {
			this._font = init["font"];
		}
		if (init.hasOwnProperty("x")) {
			this._x = init["x"];
		}
		if (init.hasOwnProperty("y")) {
			this._y = init["y"];
		}
		if (init.hasOwnProperty("shadow")) {
			this._shadow = init["shadow"];
		}
		if (init.hasOwnProperty("position")) {
			if (init["position"] === "relative") {
				this.absolute = false;
				if (this.mode < 7) {
					console.warn("Using relative position for CSA comment.");
				}
			}
		}
	}

	CoreComment.prototype.init = function (recycle) {
		if (typeof recycle === "undefined") {
			recycle = null;
		}
		if (recycle !== null) {
			this.dom = recycle.dom;
		} else {
			this.dom = document.createElement("div");
		}
		this.dom.className = this.parent.options.global.className;
		this.dom.appendChild(document.createTextNode(this.text));
		this.dom.textContent = this.text;
		this.dom.innerText = this.text;
		this.size = this._size;
		if (this._color != 0xffffff) {
			this.color = this._color;
		}
		this.shadow = this._shadow;
		if (this._border) {
			this.border = this._border;
		}
		if (this._font !== "") {
			this.font = this._font;
		}
		if (this._x !== undefined) {
			this.x = this._x;
		}
		if (this._y !== undefined) {
			this.y = this._y;
		}
		if (this._alpha !== 1 || this.parent.options.global.opacity < 1) {
			this.alpha = this._alpha;
		}
		if (this.motion.length > 0) {
			this.animate();
		}
	};

	Object.defineProperty(CoreComment.prototype, "x", {
		get: function () {
			if (this._x === null || this._x === undefined) {
				if (this.align % 2 === 0) {
					this._x = this.dom.offsetLeft;
				} else {
					this._x = this.parent.width - this.dom.offsetLeft - this.width;
				}
			}
			if (!this.absolute) {
				return this._x / this.parent.width;
			}
			return this._x;
		},
		set: function (x) {
			this._x = x;
			if (!this.absolute) {
				this._x *= this.parent.width;
			}
			if (this.align % 2 === 0) {
				this.dom.style.left = this._x + "px";
			} else {
				this.dom.style.right = this._x + "px";
			}
		},
		enumerable: true,
		configurable: true
	});

	Object.defineProperty(CoreComment.prototype, "y", {
		get: function () {
			if (this._y === null || this._y === undefined) {
				if (this.align < 2) {
					this._y = this.dom.offsetTop;
				} else {
					this._y = this.parent.height - this.dom.offsetTop - this.height;
				}
			}
			if (!this.absolute) {
				return this._y / this.parent.height;
			}
			return this._y;
		},
		set: function (y) {
			this._y = y;
			if (!this.absolute) {
				this._y *= this.parent.height;
			}
			if (this.align < 2) {
				this.dom.style.top = this._y + "px";
			} else {
				this.dom.style.bottom = this._y + "px";
			}
		},
		enumerable: true,
		configurable: true
	});

	Object.defineProperty(CoreComment.prototype, "bottom", {
		get: function () {
			return this.y + this.height;
		},
		enumerable: true,
		configurable: true
	});

	Object.defineProperty(CoreComment.prototype, "right", {
		get: function () {
			return this.x + this.width;
		},
		enumerable: true,
		configurable: true
	});

	Object.defineProperty(CoreComment.prototype, "width", {
		get: function () {
			if (this._width === null || this._width === undefined) {
				this._width = this.dom.offsetWidth;
			}
			return this._width;
		},
		set: function (w) {
			this._width = w;
			this.dom.style.width = this._width + "px";
		},
		enumerable: true,
		configurable: true
	});

	Object.defineProperty(CoreComment.prototype, "height", {
		get: function () {
			if (this._height === null || this._height === undefined) {
				this._height = this.dom.offsetHeight;
			}
			return this._height;
		},
		set: function (h) {
			this._height = h;
			this.dom.style.height = this._height + "px";
		},
		enumerable: true,
		configurable: true
	});

	Object.defineProperty(CoreComment.prototype, "size", {
		get: function () {
			return this._size;
		},
		set: function (s) {
			this._size = s;
			this.dom.style.fontSize = this._size + "px";
		},
		enumerable: true,
		configurable: true
	});

	Object.defineProperty(CoreComment.prototype, "color", {
		get: function () {
			return this._color;
		},
		set: function (c) {
			this._color = c;
			var color = c.toString(16);
			color = color.length >= 6 ? color : new Array(6 - color.length + 1).join("0") + color;
			this.dom.style.color = "#" + color;
			if (this._color === 0) {
				this.dom.className = this.parent.options.global.className + " rshadow";
			}
		},
		enumerable: true,
		configurable: true
	});

	Object.defineProperty(CoreComment.prototype, "alpha", {
		get: function () {
			return this._alpha;
		},
		set: function (a) {
			this._alpha = a;
			this.dom.style.opacity = Math.min(this._alpha, this.parent.options.global.opacity) + "";
		},
		enumerable: true,
		configurable: true
	});

	Object.defineProperty(CoreComment.prototype, "border", {
		get: function () {
			return this._border;
		},
		set: function (b) {
			this._border = b;
			if (this._border) {
				this.dom.style.border = "1px solid #00ffff";
			} else {
				this.dom.style.border = "none";
			}
		},
		enumerable: true,
		configurable: true
	});

	Object.defineProperty(CoreComment.prototype, "shadow", {
		get: function () {
			return this._shadow;
		},
		set: function (s) {
			this._shadow = s;
			if (!this._shadow) {
				this.dom.className = this.parent.options.global.className + " noshadow";
			}
		},
		enumerable: true,
		configurable: true
	});

	Object.defineProperty(CoreComment.prototype, "font", {
		get: function () {
			return this._font;
		},
		set: function (f) {
			this._font = f;
			if (this._font.length > 0) {
				this.dom.style.fontFamily = this._font;
			} else {
				this.dom.style.fontFamily = "";
			}
		},
		enumerable: true,
		configurable: true
	});


	CoreComment.prototype.time = function (time) {
		this.ttl -= time;
		if (this.ttl < 0) {
			this.ttl = 0;
		}
		if (this.movable) {
			this.update();
		}
		if (this.ttl <= 0) {
			this.finish();
		}
	};

	CoreComment.prototype.update = function () {
		this.animate();
	};

	CoreComment.prototype.invalidate = function () {
		this._x = null;
		this._y = null;
		this._width = null;
		this._height = null;
	};

	CoreComment.prototype._execMotion = function (currentMotion, time) {
		for (var prop in currentMotion) {
			if (currentMotion.hasOwnProperty(prop)) {
				var m = currentMotion[prop];
				this[prop] = m.easing(Math.min(Math.max(time - m.delay, 0), m.dur), m.from, m.to - m.from, m.dur);
			}
		}
	};

	CoreComment.prototype.animate = function () {
		if (this._alphaMotion) {
			this.alpha = (this.dur - this.ttl) * (this._alphaMotion["to"] - this._alphaMotion["from"]) / this.dur + this._alphaMotion["from"];
		}
		if (this.motion.length === 0) {
			return;
		}
		var ttl = Math.max(this.ttl, 0);
		var time = (this.dur - ttl) - this._motionStart[this._curMotion];
		this._execMotion(this.motion[this._curMotion], time);
		if (this.dur - ttl > this._motionEnd[this._curMotion]) {
			this._curMotion++;
			if (this._curMotion >= this.motion.length) {
				this._curMotion = this.motion.length - 1;
			}
			return;
		}
	};

	CoreComment.prototype.finish = function () {
		this.parent.finish(this);
	};

	CoreComment.prototype.toString = function () {
		return ["[", this.stime, "|", this.ttl, "/", this.dur, "]", "(", this.mode, ")", this.text].join("");
	};
	CoreComment.LINEAR = function (t, b, c, d) {
		return t * c / d + b;
	};
	return CoreComment;
})();

var ScrollComment = (function (_super) {
	__extends(ScrollComment, _super);
	function ScrollComment(parent, data) {
		_super.call(this, parent, data);
		this.dur *= this.parent.options.scroll.scale;
		this.ttl *= this.parent.options.scroll.scale;
	}

	Object.defineProperty(ScrollComment.prototype, "alpha", {
		set: function (a) {
			this._alpha = a;
			this.dom.style.opacity = Math.min(Math.min(this._alpha, this.parent.options.global.opacity), this.parent.options.scroll.opacity) + "";
		},
		enumerable: true,
		configurable: true
	});

	ScrollComment.prototype.init = function (recycle) {
		if (typeof recycle === "undefined") {
			recycle = null;
		}
		_super.prototype.init.call(this, recycle);
		this.x = this.parent.width;
		if (this.parent.options.scroll.opacity < 1) {
			this.alpha = this._alpha;
		}
		this.absolute = true;
	};

	ScrollComment.prototype.update = function () {
		this.x = (this.ttl / this.dur) * (this.parent.width + this.width) - this.width;
	};
	return ScrollComment;
})(CoreComment);



var CSSScrollComment = (function (_super) {
	__extends(CSSScrollComment, _super);
	function CSSScrollComment() {
		_super.apply(this, arguments);
		this._stop = false;
		this._layout = false;
		this._setX = false;
	}

	CSSScrollComment.prototype.init = function (recycle) {
		_super.prototype.init.call(this, recycle);
		(this.align % 2 === 0) ? this.dom.style.left = "auto" : this.dom.style.right = "auto";
	};

	Object.defineProperty(CSSScrollComment.prototype, "y", {
		get: function () {
			if (this._y === null || this._y === undefined) {
				if (this.align < 2) {
					this._y = this.dom.offsetTop;
				} else {
					this._y = this.parent.height - this.dom.offsetTop - this.height;
				}
			}
			if (!this.absolute) {
				return this._y / this.parent.height;
			}
			return this._y;
		},
		set: function (y) {
			if (!this._setX) {
				if (this.align % 2 === 0) {
					this.dom.style.right = (-this.dom.offsetWidth) + "px";
				} else {
					this.dom.style.left = (-this.dom.offsetWidth) + "px";
				}
				this._setX = true;
			}
			this._y = y;
			if (!this.absolute) {
				this._y *= this.parent.height;
			}
			if (this.align < 2) {
				this.dom.style.top = this._y + "px";
			} else {
				this.dom.style.bottom = this._y + "px";
			}
		},
		enumerable: true,
		configurable: true
	});

	CSSScrollComment.prototype.update = function () {
		if (!this._layout) {
			var animation = "cmt-move " + this.dur + "ms linear";
			this.dom.style.animation = animation;
			this.dom.style["-webkit-animation"] = animation;
			this.dom.style["-moz-animation"] = animation;
			this.dom.style["-o-animation"] = animation;
			this._layout = true;
		}

		if (this._stop) {
			this.dom.style["animation-play-state"] = "running";
			this._stop = false;
		}
	};

	CSSScrollComment.prototype.invalidate = function () {
		_super.prototype.invalidate.call(this);
		this._layout = false;
	};

	CSSScrollComment.prototype.stop = function () {
		this.dom.style["animation-play-state"] = "paused";
		this._stop = true;
	};

	return CSSScrollComment;
})(ScrollComment);
